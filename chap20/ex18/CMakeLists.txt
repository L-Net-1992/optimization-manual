if(CMAKE_CXX_COMPILER_ID MATCHES Clang OR CMAKE_CXX_COMPILER_ID MATCHES GNU OR CMAKE_CXX_COMPILER_ID MATCHES AppleClang)
    check_cxx_compiler_flag("-mamx-int8 -mamx-tile" COMPILER_SUPPORTS_AMX)
    if (COMPILER_SUPPORTS_AMX)
        set_property(SOURCE ex18_test.cpp APPEND PROPERTY COMPILE_OPTIONS "-DCOMPILER_SUPPORTS_AMX")
        set(amx_exx_ass amx_interleaved_gemm_relu_ass.s)
    endif()
elseif(MSVC)
    set_property(SOURCE ex18_test.cpp APPEND PROPERTY COMPILE_OPTIONS "/DCOMPILER_SUPPORTS_AMX")
    set(amx_exx_ass amx_interleaved_gemm_relu_ass.asm)
endif()

set(amx_ex18_srcs ex18_test.cpp ${amx_exx_ass})
add_executable(amx_ex18_tests ${amx_ex18_srcs})
target_link_libraries(amx_ex18_tests gtest_main optimisation_common)
add_test(NAME amx_ex18_test COMMAND amx_ex18_tests)
